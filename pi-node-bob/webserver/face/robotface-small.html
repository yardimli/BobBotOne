<!DOCTYPE html>
<html lang="en">
<head>
  <title>Elo Bob Face</title>
  <meta http-equiv="content-type" content="text/html; charset=iso-8859-1"/>

  <link href="//fonts.googleapis.com/css?family=Montserrat" rel="stylesheet">

  <script src="js/jquery-3.3.1.min.js"></script>

  <script src="js/popper.min.js"></script>
  <script src="js/bootstrap.min.js"></script>

  <link rel="stylesheet" href="css/bootstrap.min.css">

  <link href='//fonts.googleapis.com/css?family=Oswald:400' rel='stylesheet' type='text/css'>

  <link rel="icon" type="image/png" href="../webserver/favicon.ico">
</head>

<body style="background-color: #ccc;">
<header>
  <div class="collapse bg-dark" id="navbarHeader">
    <div class="container">
      <div class="row">
        <div class="col-sm-8 col-md-7 py-4">
          <h4 class="text-white">About</h4>
          <p class="text-muted">Grid Editor for Bob Micro Bot LED Face.</p>
        </div>
        <div class="col-sm-4 offset-md-1 py-4">
        </div>
      </div>
    </div>
  </div>
  <div class="navbar navbar-dark bg-dark shadow-sm">
    <div class="container d-flex justify-content-between">
      <a href="#" class="navbar-brand d-flex align-items-center">
        <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
             stroke-linejoin="round" class="mr-2" focusable="false" aria-hidden="true">
          <path d="M23 19a2 2 0 0 1-2 2H3a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h4l2-3h6l2 3h4a2 2 0 0 1 2 2z"></path>
          <circle cx="12" cy="13" r="4"></circle>
        </svg>
        <strong>Robot Face</strong>
      </a>
      <button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbarHeader" aria-controls="navbarHeader" aria-expanded="false"
              aria-label="Toggle navigation">
        <span class="navbar-toggler-icon"></span>
      </button>
    </div>
  </div>
</header>

<div style="margin: 10px;">
  <div style="vertical-align: top;">
    <div style=" display: inline-block;vertical-align: top;">
      <canvas id="canvas" width="420px" height="420px" style="background: #fff; margin:0px;"></canvas>
    </div>

    <div style=" display: inline-block;vertical-align: top;">
      <canvas id="mini_canvas" width="420px" height="420px" style="background: #fff; margin:0px;"></canvas>
    </div>
  </div>

  <div style="vertical-align: top;">
    <div class="dropdown" style=" display: inline-block;vertical-align: top;">
      <button class="btn btn-secondary dropdown-toggle" type="button" id="dropdownMenu1" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
        Operations
      </button>
      <div class="dropdown-menu" aria-labelledby="dropdownMenu1" id="face_list">
        <a class="dropdown-item" href="#AnimationModal" data-toggle="modal">Face Animations</a>
        <a class="dropdown-item" href="#exampleModal" data-toggle="modal">Save Design</a>
      </div>
    </div>

    <div class="dropdown" style=" display: inline-block;vertical-align: top;">
      <button class="btn btn-secondary dropdown-toggle" type="button" id="colorMenu" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
        Colors
      </button>
      <div class="dropdown-menu" aria-labelledby="colorMenu" id="color_list">
        <a class="dropdown-item color_menu" href="#select_color" data-toggle="modal" data-color="Red">Red</a>
        <a class="dropdown-item color_menu" href="#select_color" data-toggle="modal" data-color="Green">Green</a>
        <a class="dropdown-item color_menu" href="#select_color" data-toggle="modal" data-color="Yellow">Yellow</a>
        <a class="dropdown-item color_menu" href="#select_color" data-toggle="modal" data-color="Blue">Blue</a>
        <a class="dropdown-item color_menu" href="#select_color" data-toggle="modal" data-color="Purple">Purple</a>
        <a class="dropdown-item color_menu" href="#select_color" data-toggle="modal" data-color="Cyan">Cyan</a>
        <a class="dropdown-item color_menu" href="#select_color" data-toggle="modal" data-color="White">White</a>
      </div>
    </div>
  </div>
</div>

<div class="modal fade" id="exampleModal" tabindex="-1" role="dialog" aria-labelledby="exampleModalLabel">
  <div class="modal-dialog" role="document">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="exampleModalLabel">New Face</h5>
        <button type="button" class="close" data-dismiss="modal" aria-label="Close">
          <span aria-hidden="true">&times;</span>
        </button>
      </div>
      <div class="modal-body">
        <div class="form-group">
          <label for="face_name" class="control-label">Face Name:</label>
          <input type="text" class="form-control" id="face_name">
        </div>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-default" data-dismiss="modal">Close</button>
        <button type="button" class="btn btn-primary" id="save_face">Save Face</button>
      </div>
    </div>
  </div>
</div>


<div class="modal fade" id="AnimationModal" tabindex="-1" role="dialog" aria-labelledby="AnimationModalLabel">
  <div class="modal-dialog" role="document">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="AnimationModalLabel">New Face Animation</h5>
        <button type="button" class="close" data-dismiss="modal" aria-label="Close">
          <span aria-hidden="true">&times;</span>
        </button>
      </div>
      <div class="modal-body">

        <div class="form-group">
          <div class="dropdown">
            <button class="btn btn-default dropdown-toggle" type="button" id="AnimationMenu" data-toggle="dropdown" aria-haspopup="true" aria-expanded="true"
                    style=""> Animations&nbsp;<span class="caret"></span>
            </button>
            <ul class="dropdown-menu" aria-labelledby="AnimationMenu" id="face_animation_list">
            </ul>
          </div>
        </div>

        <div class="form-group">
          <label for="face_animation_name" class="control-label">Face Animation Name:</label>
          <input type="text" class="form-control" id="face_animation_name">
        </div>

        <div class="form-group">
          <label for="animation_cmd" class="control-label">Face Animation:</label>
          <textarea class="form-control" id="animation_cmd"></textarea>
        </div>
      </div>

      <div class="modal-footer">
        <button type="button" class="btn btn-default" data-dismiss="modal">Close</button>
        <button type="button" class="btn btn-default" id="play_face_animation">Play Animation</button>
        <button type="button" class="btn btn-primary" id="save_face_animation">Save Animation</button>
      </div>
    </div>
  </div>
</div>

</body>

<script>
  var canvas = document.getElementById("canvas");
  var context = canvas.getContext("2d");

  var mini_canvas = document.getElementById("mini_canvas");
  var mini_context = mini_canvas.getContext("2d");

  var p = 0;

  var Highlights = [];
  var MouseCurrentX = 0;
  var MouseCurrentY = 0;
  var CurrentColor = "blue";
  var LastMouseCurrentX = 0;
  var LastMouseCurrentY = 0;
  var SaveHighlights = [];

  var PlayAnimationSeq = [];
  var PlayAnimationRow = 0;
  var PlayAnimation = false;
  var PlayAnimationIntCounter = 0;

  var DivideMiniScreen = 2.5;

  //---------------------------------------------------------------------------------------------------------------------------
  function LoadFaceFile(face_name) {
    var UrlToGet = "load_face.php";
    var data = {"face_name": face_name};

    $.ajax({
      url: UrlToGet,
      data: data,
      dataType: "json",
      success: function (data, status) {
        Highlights = data;
        drawLED();
        drawBoard();
//        writeMessage(canvas, "##MYIP##");

        console.log("Status: " + status);
      },
      error: function (data, status) {
        console.log("error Status: " + status);
      }

    });
  }


  //---------------------------------------------------------------------------------------------------------------------------
  function drawLED() {
    var grd;

    for (var y = 0; y <= 8 * 40; y += 40) {
      for (var x = 0; x <= 16 * 40; x += 40) {
        grd = context.createLinearGradient(0.5 + x, 0.5 + y, 0.5 + x + 40, 0.5 + y + 40);

        if ((y / 40) === MouseCurrentY && (x / 40) === MouseCurrentX) {
          grd.addColorStop(0, "red");
          grd.addColorStop(1, "#333");
        }
        else {
          grd.addColorStop(0, "#000");
          grd.addColorStop(1, "#333");
        }

        context.fillStyle = grd;
        context.fillRect(0.5 + x, 0.5 + y, 40, 40);

        grd = context.createLinearGradient(0.5 + (x / DivideMiniScreen), 0.5 + (y / DivideMiniScreen), 0.5 + (x / DivideMiniScreen) + (40 / DivideMiniScreen), 0.5 + (y / DivideMiniScreen) + (40 / DivideMiniScreen));
        grd.addColorStop(0, "#000");
        grd.addColorStop(1, "#222");
        mini_context.fillStyle = grd;
        mini_context.fillRect(0.5 + (x / DivideMiniScreen), 0.5 + (y / DivideMiniScreen), 40 / DivideMiniScreen, 40 / DivideMiniScreen);


      }
    }

//    console.log(Highlights.length);
    for (var i = 0; i < Highlights.length; i++) {

      grd = context.createLinearGradient(
        0.5 + (Highlights[i].X * 40),
        0.5 + (Highlights[i].Y * 40),
        0.5 + 40 + (Highlights[i].X * 40),
        0.5 + 40 + (Highlights[i].Y * 40));

      var DrawColor = "Yellow";
      if (typeof Highlights[i].Color === "undefined") {

      }
      else {
        DrawColor = Highlights[i].Color;
      }

      grd.addColorStop(0, DrawColor);
      grd.addColorStop(1, "#333");

      context.fillStyle = grd;
      context.fillRect(
        0.5 + (Highlights[i].X * 40),
        0.5 + (Highlights[i].Y * 40),
        40,
        40);

      grd = context.createLinearGradient(
        0.5 + (Highlights[i].X * (40 / DivideMiniScreen)),
        0.5 + (Highlights[i].Y * (40 / DivideMiniScreen)),
        0.5 + (40 / DivideMiniScreen) + (Highlights[i].X * (40 / DivideMiniScreen)),
        0.5 + (40 / DivideMiniScreen) + (Highlights[i].Y * (40 / DivideMiniScreen)));
      grd.addColorStop(0, DrawColor);
      grd.addColorStop(1, DrawColor);

      mini_context.fillStyle = grd;
      mini_context.fillRect(
        0.5 + (Highlights[i].X * (40 / DivideMiniScreen)),
        0.5 + (Highlights[i].Y * (40 / DivideMiniScreen)),
        (40 / (DivideMiniScreen + 2)),
        (40 / (DivideMiniScreen + 2)));

    }
  }


  //---------------------------------------------------------------------------------------------------------------------------
  function drawBoard() {

    for (var y = 0; y <= 16 * 40; y += 40) {
      context.moveTo(0.5 + y + p, p);
      context.lineTo(0.5 + y + p, bh + p);
    }


    for (var x = 0; x <= 8 * 40; x += 40) {
      context.moveTo(p, 0.5 + x + p);
      context.lineTo(bw + p, 0.5 + x + p);
    }

    context.strokeStyle = "black";
    context.stroke();
  }

  //---------------------------------------------------------------------------------------------------------------------------
  function writeMessage(canvas, message) {
    context.font = '12pt Calibri';
    context.fillStyle = 'white';
    context.fillText(message, 10, 25);
  }

  //---------------------------------------------------------------------------------------------------------------------------
  function getMousePos(canvas, evt) {
    var rect = canvas.getBoundingClientRect();
    return {
      x: evt.clientX - rect.left,
      y: evt.clientY - rect.top
    };
  }


  //---------------------------------------------------------------------------------------------------------------------------
  $(document).ready(function () {

    setInterval(function () {
      if (PlayAnimation && PlayAnimationSeq.length > 0) {
        PlayAnimationIntCounter++;

        if (PlayAnimationRow == -1) {
          PlayAnimationRow = 1;
          PlayAnimationIntCounter = 0;
        }

        if (PlayAnimationIntCounter > PlayAnimationSeq[PlayAnimationRow - 1]["Delay"]) {

          PlayAnimationRow++;
          if (PlayAnimationRow > PlayAnimationSeq.length) {
            PlayAnimationRow = 1;
          }

          LoadFaceFile(PlayAnimationSeq[PlayAnimationRow - 1]["FileName"] + ".txt");
          PlayAnimationIntCounter = 0;
        }
      }
    }, 100);


    //---------------------------------------------------------------------------------------------------------------------------
    var UrlToGet = "load_faces.php";

    var data = {};

    $.ajax({
      url: UrlToGet,
      data: data,
      dataType: "json",
      success: function (data, status) {
        for (face in data) {
          $("#face_list").append('<a  class="dropdown-item load_face" href="#"  data-face_name="' + data[face] + '">' + data[face] + '</a>\n');
        }

        //---------------------------------------------------------------------------------------------------------------------------
        $(".load_face").on('click', function (e) {
          console.log("load face");
          LoadFaceFile($(this).data("face_name"));
          e.preventDefault();
        });

        console.log("Status: " + status);
      },
      error: function (data, status) {
        console.log("error Status: " + status);
      }

    });

    //---------------------------------------------------------------------------------------------------------------------------
    $(".color_menu").on('click', function (e) {
      CurrentColor = $(this).data("color");
      e.preventDefault();
    });


    //---------------------------------------------------------------------------------------------------------------------------
    var UrlToGet = "load_face_animations.php";

    var data = {};

    $.ajax({
      url: UrlToGet,
      data: data,
      dataType: "json",
      success: function (data, status) {
        for (face in data) {
//          console.log(data[face]);
          $("#face_animation_list").append('<a href="#" class="dropdown-item load_face_animation" data-face_animation_name="' + data[face] + '">' + data[face] + '</a>\n');
        }

        //---------------------------------------------------------------------------------------------------------------------------
        $(".load_face_animation").on('click', function (e) {
          console.log("load face animation");
          var animation_short_name = $(this).data("face_animation_name");
          animation_short_name = animation_short_name.replace(".txt", "");
          animation_short_name = animation_short_name.replace("animation_", "");
          $("#face_animation_name").val(animation_short_name);

          var UrlToGet = "load_face_animation.php";
          var data = {"face_animation_name": $(this).data("face_animation_name")};

          $.ajax({
            url: UrlToGet,
            data: data,
            dataType: "text",
            success: function (data, status) {
              $("#animation_cmd").val(data);

              console.log("Status: " + status);
            },
            error: function (data, status) {
              console.log("error Status: " + status);
            }

          });

          e.preventDefault();
        });

        console.log("Status: " + status);
      },
      error: function (data, status) {
        console.log("error Status: " + status);
      }

    });


    //---------------------------------------------------------------------------------------------------------------------------
    $("#play_face_animation").on('click', function (e) {

      PlayAnimationSeq = [];

      var TempList = $("#animation_cmd").val();

      TempList = TempList.replace(/\r\n/g, "\r").replace(/\n/g, "\r").split(/\r/);

      console.log(TempList);

      for (var i = 0; i < TempList.length; i++) {
        var TempRow = TempList[i].split(";");
        if (TempRow.length == 2) {
          PlayAnimationSeq.push({"FileName": TempRow[0].trim(), "Delay": TempRow[1].trim()});
        }
      }
      console.log(PlayAnimationSeq);

      PlayAnimationRow = -1;
      PlayAnimationIntCounter = 0;
      PlayAnimation = true;

      $("#AnimationModal").modal('hide');
    });

    //---------------------------------------------------------------------------------------------------------------------------
    $("#save_face_animation").on('click', function (e) {
      console.log("save face press");
      if ($("#face_animation_name").val() !== "") {
        console.log("save face animation");

        var UrlToGet = "save_face_animation.php";
        var data = {"animation_cmd": $("#animation_cmd").val(), "face_animation_name": $("#face_animation_name").val()};

        $.ajax({
//          type:"post",
          url: UrlToGet,
          data: data,
          dataType: "json",
          success: function (data, status) {
            console.log("Status: " + status);
          },
          error: function (data, status) {
            console.log("error Status: " + status);
          }

        });
//        $("#AnimationModal").modal('hide');
      }
      else {
        alert("face animation name?");
      }
      e.preventDefault();
    });


    //---------------------------------------------------------------------------------------------------------------------------
    $("#save_face").on('click', function (e) {
      console.log("save face press");
      if ($("#face_name").val() !== "") {
        console.log("save face");
        SaveHighlights = Highlights.slice(0);

        var UrlToGet = "save_face.php";
        var data = {"highlight": JSON.stringify(SaveHighlights), "face_name": $("#face_name").val()};

        $.ajax({
//          type:"post",
          url: UrlToGet,
          data: data,
          dataType: "json",
          success: function (data, status) {
            console.log("Status: " + status);
          },
          error: function (data, status) {
            console.log("error Status: " + status);
          }
        });
        $("#exampleModal").modal('hide');
      }
      else {
        alert("face name?");
      }
      e.preventDefault();
    });


    //---------------------------------------------------------------------------------------------------------------------------
    bw = 40 * 16;//window.innerWidth;
    bh = 40 * 8;// window.innerHeight;
    canvas.width = bw;
    canvas.height = bh;

    mini_canvas.width = bw / DivideMiniScreen;
    mini_canvas.height = bh / DivideMiniScreen;

    drawLED();
    drawBoard();

    setTimeout(function () {
      drawLED();
      drawBoard();
    }, 2000);

    canvas.addEventListener('mousemove', function (evt) {
      var mousePos = getMousePos(canvas, evt);

      MouseCurrentX = Math.floor(mousePos.x / 40);
      MouseCurrentY = Math.floor(mousePos.y / 40);

      if (MouseCurrentX >= 16) {
        MouseCurrentX = 16;
      }
      if (MouseCurrentY >= 8) {
        MouseCurrentY = 8;
      }

      if (MouseCurrentX !== LastMouseCurrentX || MouseCurrentY !== LastMouseCurrentY) {
        LastMouseCurrentX = MouseCurrentX;
        LastMouseCurrentY = MouseCurrentY
        var message = 'Mouse position: ' + MouseCurrentX + ',' + MouseCurrentY;

        drawLED();
        drawBoard();

//        writeMessage(canvas, message);
//        writeMessage(canvas, "##MYIP##");
      }
    }, false);


    canvas.addEventListener('click', function (event) {
//	console.log("click");


      PlayAnimation = false;
      var DeleteDot = false;
      for (var i = 0; i < Highlights.length; i++) {
        if (Highlights[i].X == MouseCurrentX && Highlights[i].Y == MouseCurrentY) {
          Highlights.splice(i, 1);
          DeleteDot = true;
          break;
        }
      }

      if (!DeleteDot) {
        Highlights.push({X: MouseCurrentX, Y: MouseCurrentY, Color: CurrentColor});
      }

      drawLED();
      drawBoard();
    }, false);


  });
</script>